---
title: "JPA 02.기초CRUD"
excerpt: "기초적인 CRUD를 실습해보며 동작원리를 파악"
categories:
    - JPA
tags:
    - EntityManagerFactory
    - EntityManager
last_modified_at: 2021-05-21
---

## 엔티티 생성

* `Member` 클래스를 작성해서 테이블과 매핑을 하자.
* 빠른 진행을 위해 스키마 자동생성 기능을 CREATE로 두자.
    * 물론 이 기능을 끄고 DB에서 직접 테이블을 생성 후 진행해도 된다.
* 이후 `StartJPA1` 클래스를 작성하자.

<img src="/image/JPA/crud/1.png" alt="1.png" class="align-center">  
  
<img src="/image/JPA/crud/2.png" alt="2.png" class="align-center">  

## EntityManagerFactory
* JPA를 시작하려면 일단 `persistence.xml`의 설정정보를 가져와 `EntityManagerFactory`를 생성해야 한다.
* `createEntityManagerFactory()`를 통해 생성이 되는데 JPA의 구현체에 따라서 커넥션 풀도 같이 생성한다.
* 이때 생성비용이 굉장히 크다. 그러므로 **애플리케이션 전체에서 딱 한번만 생성하고, 공유해서 사용을 해야 한다.**
* 마지막에는 `close()`를 통해 메모리 관리를 하자.

## EntityManager
* EntityManager는 JPA의 기능 대부분을 제공한다. (ex : CRUD)
* 내부에 커넥션을 유지하면서 DB와 통신 (가상의 DB라고 생각해도 무방하다.)
* EntityManagerFactory는 공유해도 상관없다 했지만, **EntityManager은 DB 커넥션과 밀접한 관계가 있어서 스레드간에 공유하거나 재사용하면 \*동시성 문제가 발생한다. 절대 공유하면 안된다!!**
* 마지막에 close()를 통해 반드시 종료 하자.

## Transaction
* JPA를 사용하려면 항상 트랜젝션 안에서 데이터를 변경해야 한다. (EntityManager의 getTransaction())
  
  <img src="/image/JPA/crud/transaction.png" alt="트랜잭션 동작원리.png" class="align-center">
* 전체적인 동작 원리

***

## CRUD
* EntityManager은 JPA의 기능 대부분을 제공한다고 하였다. 그 중 CRUD를 실습해보자.

### Create
* 회원 엔티티를 생성 후 `persist()` 메소드에 저장할 엔티티를 넘겨주면 끝이다.
* 그러면 JPA는 매핑 정보를 통해 SQL 쿼리를 생성 후 DB에 전달하게 된다.

```java
public static void create(EntityManager em) {
     //데이터 입력
     Member newMember = new Member();
     newMember.setId(1L);
     newMember.setName("nameA");

     //persist() 메소드를 통해 등록
     em.persist(newMember);
}
```

### Read
```java
public static void read(EntityManager em) {
      /** 
      * 방법 1 : find() 메소드 사용
      */
      Member findMember = em.find(Member.class, 1L);
      System.out.println("findMember.getId() = " + findMember.getId());       
      System.out.println("findMember.getName() = " + findMember.getName());

      /** 
      * 방법 2 : 직접 JPQL 작성.
      */
      List<Member> result = em.createQuery("select m from Member as m", Member.class)
              .setFirstResult(5) // 페이지 설정 (= 페이징 기능)
              .setMaxResults(8)
              .getResultList(); // 결과 리스트

      출력
      for (Member member : result) {
          System.out.println("member.name = " + member.getName());
      } 
}
```

* 방법1. find() 메소드를 사용
    * `find(엔티티 클래스 타입, 식별자 값(@Id로 매핑된 값))`
* 방법2. createQuery() 메소드를 통한 JPQL 쿼리 직접 작성
    * `createQuery(JPQL 쿼리, 타켓 엔티티)`
    * 이후 여러개라면 getResultList()를, 하나라면 getSingleResult()

### Update
```java
public static void update(EntityManager em) {
    Member updateMember = em.find(Member.class, 3L);    // 수정하고 싶은 데이터 찾기
    updateMember.setName("UpdatedNameC");                // setter을 통해 수정
}
```

* 업데이트 기능은 더욱 재밋다. 따로 어떤 메소드를 입력하지 않았는데도 데이터가 업데이트 되기 때문이다.
* 이는 후에 배울 \*영속성과 \*더티체킹 기능과 관련있다.
    * 간략 설명 : commit 시점에 JPA가 데이터 비교 후 원본과 다르면 자동으로 업데이트 쿼리를 생성해서 업데이트를 실행.

### Delete
```java
public static void delete(EntityManager em) {
    Member deleteMember = em.find(Member.class, 3L);
    em.remove(deleteMember);
}
```
* EntityManager의 `remove(원하는 데이터)` 메소드를 사용하면 된다.

***

#### 출처

* JPA Reference : [https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#reference](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#reference)
* 도서 : 자바 ORM 표준 JPA 프로그래밍
